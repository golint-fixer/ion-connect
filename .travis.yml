sudo: false
services:
  - docker
addons:
  apt:
    packages:
    - rpm
    - alien
    - dpkg-dev
    - debhelper
    - build-essential
    - jq
language: go
go:
  - 1.6.2
install:
  - bundle
  - go get github.com/GeertJohan/go.rice
  - go get github.com/GeertJohan/go.rice/rice
  - go get -v github.com/Masterminds/glide
  - cd $GOPATH/src/github.com/Masterminds/glide && git checkout 8460774 && go install
    && cd -
  - glide install
  - gem install fpm
script:
  - export GOBIN=$GOPATH/bin
  - IONCHANNEL_SECRET_KEY="" go test -v ./lib
  - GOOS=windows go build -o ion-connect/windows/bin/ion-connect.exe ./
  - rice append --exec ion-connect/windows/bin/ion-connect.exe -i ./lib
  - GOOS=linux go build -o ion-connect/linux/bin/ion-connect ./
  - rice append --exec ion-connect/linux/bin/ion-connect -i ./lib
  - GOOS=darwin go build -o ion-connect/darwin/bin/ion-connect ./
  - rice append --exec ion-connect/darwin/bin/ion-connect -i ./lib
  - cp ion-connect/$(echo "$(uname)" | perl -ne 'print lc')/bin/ion-connect $GOPATH/bin
  - IONCHANNEL_ENDPOINT_URL=$CI_ENDPOINT_URL cucumber -t ~@expected_failure
  - VERSION=`if [ $TRAVIS_TAG -z ]; then echo 'master'; else echo $TRAVIS_TAG; fi`
  - FILE_NAME=ion-connect-$VERSION-$TRAVIS_BUILD_NUMBER
  - cp bin/process-ion-job.sh ion-connect/linux/bin/
  - cp bin/process-ion-job.sh ion-connect/darwin/bin/
  - tar cfvz $FILE_NAME.tar.gz ion-connect
  - ls -l
  - fpm -s dir -t rpm -n ion-connect --iteration $TRAVIS_BUILD_NUMBER -v $VERSION -C
    ion-connect/linux
  - fpm -s dir -t deb -n ion-connect --iteration $TRAVIS_BUILD_NUMBER -v $VERSION -C
    ion-connect/linux
before_deploy:
  - mkdir -p ion-connect/$TRAVIS_TAG
  - cp $FILE_NAME.tar.gz ion-connect/$TRAVIS_TAG/
  - cp $FILE_NAME.tar.gz ion-connect/ion-connect-latest.tar.gz
after_success:
  - if [ "$TRAVIS_BRANCH" == "master" ]; then
    make dockerize;
    docker login -e="$HUB_DOCKER_EMAIL" -u="$HUB_DOCKER_USER" -p="$HUB_DOCKER_PASSWORD";
    docker push ionchannel/ion-connect;
    fi
deploy:
  - provider: s3
    bucket: public.ionchannel.io
    region: us-east-1
    skip_cleanup: true
    # access_key_id: AWS_ACCESS_KEY
      # secure: nJYUE10X54POvO326yqNmY6ICZdJGXgH1nU7DrbKHzi1hJaI7td8/JWDulicwJgvGJSkuoVPE6TEOYYfIJObxlZuDM7qKLD060eFgmS1YfHf47ntk6Pc2LhyioyXzahmLH1NEkDVRRtFmTyvt4qlLJR455sEa8fI4Oy/I03f4xXab9tD6zPaVRx2RBfaSvN8LMOyEsT33E7hjHI+vtTwGywe/Hl/WhEsZE2TvS9uvS4xNM1LJDJuwW7qcEKoK0lrmxObaMsjxidwl5UmMW5x8OmEQvmkaR31SRVw9VeouLy0pPBQERhfc2h0WpaxHkt1SHXa2vamx7fVW8e3aabF48qcdAjg34lQk8DxPquW/74h+dFBONnLLXUiiHfAYNCWCZYj/wA4f5UKE5BdKrYFMxCDBF0cugX7wE9JIRhWQ24riYxc01/ctEHOIkteHPzG/ljiWkPU5nr7wa8F1mnUOvEyXRvxybbbp3gFVIJvLoAoXpclu3u0Lyal1TxHeAMN1mCy+T1PLikpSt9h10eIzIF0PWVozukbHSWW6p1Egq/k5bFMnYhkGld9uObpi8BLRql07NOaHRzjhDGjkstro37Q6cMtI8YDtQMYC1VTSQMWEld19vCNtPBfK997WGICeZmqxmtkCIpOg9hVwi1RfpWqeouCbdIfuCJ1qgaOLDE=
    # secret_access_key:
      # secure: TVl0qoUZbZXKeYZCgkKY+dhUnAnRlFqBstA9v3PzCI9IlRLa1a8newZZYpKQ7NvdYPzzJ+6x/tfqQfEaTjvlwAfQU32HM5p2z6xwUvyP6Ny+OpWgblfb3+5KyPZWyzv87CfTNLIQXjRIZdRc47YBUmA7sIxRrlFgTcNYjizqbPwpxj03LRk5Cdw+18FI/vxp3QHOYzWfjecKqUG9nB1x6NXZ4JmHorhY/7Ae3dY64qtZCxgpdi9RGZ87Q5xpPqbjyg3OcPnDeEp0O+sudBgxW8mdwd3CiXwXjx2Bp0ziItlf2RC58ATmH4eWzztnRkCjcxjSE1Q8ZP+5xbvHf7N0uIih51CW/bA4rrWTP2Aei56qoEisLIZvI86YPPYFFyIspVeu2fb70sUiW56O+IuX0ilmVqW+kBKU2qfqloTEk0hXEMZKuxh50vyHVKuROAvnsGqO5AKl/l7TsYQp4cXoNlCbb96VgRuls6khedwkxKcEJfIIfRBPFtM8ihw8DSREO3anmoqwSCTxJEwtw5xBiQ2RPfAdF5JxlSn6lpaXTNLJp0SywL+B5uvnpoBj854VsamuwsJXVRVMP2Y7fKuglGCeDhqpHliorvMJUzsGqIfNq7Bm26GvBtW+B/Bg3+kZmiO1NeA5AizpfdULanlWki979gZ3xLFeZsDsClcoDY0=
    upload-dir: files/ion-connect
    local_dir: ion-connect
    on:
      tags: true
after_deploy:
  - curl -v -F package=@ion-connect_$VERSION-${TRAVIS_BUILD_NUMBER}_amd64.deb https://push.fury.io/$GEMFURY_TOKEN/
  - curl -v -F package=@ion-connect-$VERSION-$TRAVIS_BUILD_NUMBER.x86_64.rpm https://push.fury.io/$GEMFURY_TOKEN/
notifications:
  slack:
    rooms:
      secure: H4/dc+yBvYYEO/4JdCiMsjCYkffi/87Wfz0/Xe5cyYXUHmYjO9129T7qJgBXbudB/leVWhxe1EgejwQz6o91i7hqpSJjMC2fB+KJcWjqkdM8xxX/hsbyfFAXpq4sPfdxAgikVHfjrg8pktuZZt8wJuTH0kVpRCsRIP/T0qRREYhOA+CUK5rlP1/ewl6p3RIsSTJkLPNNraGEgPeBfQcTWxRmbFqCPmbAZ0AOBtZiNRjyuaS4BxF59Hezv2UkPpamL+X8bZXVpik4F/wYvqnoKnm9IT0DAys5I4LgPWICCdJnMfK2dLPR90QFAkIleh8JhtVOj3QVhWCdHXZjAYJzuw/PFz3peuQ853xfF0zexwSwqx0IOO4en7w4HoyLkX2USerfKtzIqiLIoV26AqA35K/i0YKmYMDhFTIAm6wl1rh8BXKblK5llkker2JhVqTin/VEvuj6yAEY/oIXM3lNiH2jbh0RGWYf3U7qOoFFebV7rdsmZ61B3qZwKCuKFjAnNe8xBBMNuZmU4el0WRVFMdljRUspt3ydhWnoGpXFDquPdU16zz9osnG9mOmub73pH8/dQLrJFspd1VbMTEZmQ/L53QXHtaAaWwGbYjeVte/rYGnu0Wi854SatfaoumJmfWT0IsidKu0wWBMU7Q+NJMi1SSV/4yMJNdBessfD5xs=
